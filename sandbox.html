<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>INSIGHTS|sandbox</title>
    <link rel="shortcut icon" href="favicon.ico">

    <!--
    <link rel="stylesheet" type="text/css" href="css/insights.css">
    -->

    <style>
        body {
            margin: 5px;
            background-color: #333;
        }

        .thumbnails {
            display: flex;
            flex-wrap: wrap;
        }

        .thumbnails.dimmed { opacity: 0.25; }
        .thumbnails canvas {
            margin: 3px;
            box-shadow: 1px 1px 2px #000;
        }

        .player-container {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;

            display: flex;
            align-items: center;
            justify-content: center;

            pointer-events: none;
        }

        .player {
            display: flex;
            box-sizing: border-box;
            box-shadow: 4px 4px 4px #333;
            width: 600px;
            height: 500px;
        }

        .player canvas {
            flex: 1
        }

        .debug {
            position: absolute;
            left: 10px;
            top: 10px;
            color: white;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-line;
        }
    </style>

    <script>
        if (location.hostname == 'localhost') {
            document.write(
                '<script src="http://' +
                (location.host || 'localhost').split(':')[0] +
                ':35729/livereload.js"></' +
                'script>');
        }
    </script>
</head>
<body>
    <!-- containers for thumbnails and player -->
    <div class="thumbnails"></div>
    <div class="player-container">
        <div class="player"></div>
    </div>
    <div class="debug"></div>

    <script src="js/vendor/jquery-2.1.3.min.js"></script>
    <script src="js/vendor/lodash.min.js"></script>
    <script src="js/vendor/webfont.js"></script>
    <script src="js/giflib.js"></script>
    <script src="js/insights.js"></script>
    <script src="js/insights-2016.js"></script>

    <script>

        function main() {

            var debug = {
                text: [],
                $el: $('.debug'),

                print: function(text) {
                    this.text.push(text);
                    this.update();
                },

                update: function() {
                    this.$el.text(this.text.join('\n'));
                },

                clear: function() {
                    this.text = [];
                    this.update();
                }
            };

            var insight_tiles = [];
            function render_thumbnails(tiles) {
                tiles.forEach(function(tile) {
                    if (!tile) return;

                    var canv = INSIGHTS.preview(tile.content, THUMBNAIL_SIZE);
                    var ctx = canv.getContext('2d');

                    insight_tiles.push(tile);

                    var $el = $(canv).addClass('thumbnail');
                    $thumbnails.append($el);
                });
            }

            var THUMBNAIL_SIZE = 300;
            var $thumbnails = $('.thumbnails');
            var $player = $('.player');
            $player.hide();

            var logo_bar = new Image();
            logo_bar.src = 'img/logo_bar_with_icons.png';

            var insight_tiles = [];

            function get_insight_tiles() {
                return $.getJSON('2016-tiles.json').then(function(data) {
                    return _.map(data, d => ({
                        type: 'insight',
                        url: 'http://www.usopen.org/index.html',
                        tags: [ 2 ],
                        content: {
                            id: 'A',
                            version: '2016',
                            data: d
                        }
                    }));
                });
            }

            get_insight_tiles().then(function(tiles) {
                insight_tiles = tiles;
                debug.print('Loading fonts...');
                INSIGHTS.load_fonts(function() {
                    debug.clear();

                    if (logo_bar.complete)
                        render_thumbnails(tiles);
                    else
                        logo_bar.onload = function() {
                            render_thumbnails(tiles);
                        };
                });
            });

            var playing = false;

            // click on thumbnail to open animation in player
            $thumbnails.on('click', 'canvas', function(e) {
                var tile = insight_tiles[ $(this).index() ];
                var el = INSIGHTS.play(tile.content);

                // make player tile 2x
                var tile_w = 2 * $(this).width();
                var tile_h = 2 * $(this).height();

                $player
                    .html(el)
                    .css({ width: tile_w + 'px', height: tile_h + 'px' })
                    .show();

                $thumbnails.addClass('dimmed');
                playing = true;
                //e.preventDefault();
                return false;
            });

            // click on animation to stop it
            $(document).on('click', function() {
                INSIGHTS.stop();
                $player.hide();
                $thumbnails.removeClass('dimmed');
                playing = false;
            });

            // hover/rollover to animate
            $('.thumbnails').on('mouseenter mouseleave', '.thumbnail', function(e) {
                var tile_index = $(this).index();
                //console.log(tile_index, e.type, playing);

                if (playing) {
                    // no rollover animation when playing
                    return;
                }

                if (e.type == 'mouseenter') {
                    var tile_data = insight_tiles[tile_index];
                    INSIGHTS.play(tile_data.content, this);
                } else if (e.type == 'mouseleave') {
                    INSIGHTS.stop();
                }
            });

            // good but needs to return to preview image...
        }

        $( main );

    </script>

</body>
</html>
